# Protocol Specification
## Handshake Message

The handshake message is sent by the client to the server. Regardless of whether the authentication is successful, the server will not generate any response.

- Type: Used to distinguish packet types, always 0
- TUN IP: Used to map the destination address to the WebSocket
- Timestamp: Used to check the handshake time to avoid replay attacks
- Hash: Used for authentication, generated by password, TUN IP, and timestamp
- Confusion: Used to hide the fixed length characteristics of the message, occupying random length, and filling with random content

```plaintext
+--------------------------------------------------------------------------------------------------+
| Type (1 Byte) | TUN IP (4 Bytes) | Timestamp (8 Bytes) | Hash (32 Bytes) | Confusion (n Byte[s]) |
+--------------------------------------------------------------------------------------------------+
```

## IP Packet Forwarding Message

The client and server send messages to each other. The client forwards the data read from TUN to the server and forwards the data received from the server to TUN. After receiving the packet, the server parses the source address IP, verifies whether the mapping relationship between the IP and WebSocket is established, obtains the destination address IP, and forwards the packet to the corresponding WebSocket.

- Type: Used to distinguish packet types, always 1
- Raw: Raw data at the IP layer

```plaintext
+-------------------------------+
| Type (1 Byte) | Raw (n Bytes) |
+-------------------------------+
```

## Dynamic Address Message

The client uses the dynamic address message to request an available address from the server.

- Type: Used to distinguish packet types, always 2
- Timestamp: Used to check the handshake time to avoid replay attacks
- CIDR: A string ending with "\0", the client carries the address it wants to use, and the server tries to allocate this address first
- Hash: Used for authentication, generated by password, TUN IP, and timestamp
- Confusion: Used to hide the fixed length characteristics of the message, occupying random length, and filling with random content

```plaintext
+-------------------------------------------------------------------------------------------------+
| Type (1 Byte) | Timestamp (8 Bytes) | CIDR (32 Bytes) | Hash (32 Bytes) | Confusion (n Byte[s]) |
+-------------------------------------------------------------------------------------------------+
```

## Peer Connection Public Network Information Exchange Message

The clients of the peer connection pass their public network information to each other through the server.

- Type: Used to distinguish packet types, always 3
- Src: Virtual source address
- Dst: Virtual destination address
- IP: The public network address used by this client for peer connection
- Port: The public network port used by this client for peer connection listening

```plaintext
+-------------------------------------------------------------------------------+
| Type (1 Byte) | Src (4 Bytes) | Dst (4 Bytes) | IP (4 Bytes) | Port (2 Bytes) |
+-------------------------------------------------------------------------------+
```

## Virtual Hardware Address Message

In the original design, the same client should disconnect and reconnect. In actual use, it was found that due to network reasons, a client would reconnect after a period of time, and the server would disconnect the previous connection. This would cause the client with an automatically allocated address to be reallocated a new address. To solve this problem, a virtual hardware address similar to the MAC address at the transport layer is introduced. This value is randomly generated. There is a risk of collision with randomly generated addresses. A conflict will only occur if two different clients generate the same virtual hardware address and the virtual IP addresses are the same. In this case, the cached virtual hardware address needs to be manually deleted.

- Type: Used to distinguish packet types, always 4
- VMac: Virtual hardware address
- Timestamp: Used to check the handshake time to avoid replay attacks
- Hash: Used for authentication, generated by password, virtual hardware address, and timestamp
- Confusion: Used to hide the fixed length characteristics of the message, occupying random length, and filling with random content

```plaintext
+--------------------------------------------------------------------------------------------- --+
| Type (1 Byte) | VMac(16 Bytes) | Timestamp (8 Bytes) | Hash (32 Bytes) | Confusion (n Byte[s]) |
+------------------------------------------------------------------------------------------------+
```

## Active Discovery Message

Send a notification to the other party to actively try to establish a peer connection when there is no data traffic. The destination address can be the broadcast address `255.255.255.255`.

- Type: Used to distinguish packet types, always 5
- Src: Virtual source address
- Dst: Virtual destination address

```plaintext
+-----------------------------------------------+
| Type (1 Byte) | Src (4 Bytes) | Dst (4 Bytes) |
+-----------------------------------------------+
```

## GENERAL Message

In the future, there may be many messages similar to active discovery messages. These messages only need to be forwarded by the server without the server understanding the content of the message. Therefore, a general message format is added.

- Type: Used to distinguish packet types, always 255
- Subtype: Subtype
- Extra: Custom content used by the subtype
- Src: Virtual source address
- Dst: Virtual destination address
- Data: Data part of the subtype

```plaintext
+------------------------------------------------------------------------------------------------------+
| Type (1 Byte) | Subtype (1 Byte) | Extra (2 Byte) | Src (4 Bytes) | Dst (4 Bytes) | Data (n Byte[s]) |
+------------------------------------------------------------------------------------------------------+
```

Subsequent messages are implemented by GENERAL

### Exchange LAN Address and Port

Some devices are in the same LAN, and they can establish a connection without using a public IP. Therefore, a message similar to the peer connection public network information exchange message is added, but the address and port are replaced with LAN information.

- Subtype: 0
- Extra: 0
- IP: LAN IPv4 address
- Port: LAN port number

```plaintext
+-------------------------------+
| IP (4 Bytes) | Port (2 Bytes) |
+-------------------------------+
```
